<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>写字楼信息</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<!--标准mui.css-->
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" type="text/css" href="../css/common.css" />
		<link rel="stylesheet" type="text/css" href="../css/style.css" />
		<link rel="stylesheet" type="text/css" href="../css/express.css" />
		<link href="../css/mui.picker.css" rel="stylesheet" />
		<link href="../css/mui.poppicker.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/mui.picker.min.css" />
		<link href="../css/building_information.css" rel="stylesheet" />
		<style>
			.mui-table-view-chevron .mui-table-view-cell>a:not(.mui-btn) {
				margin-right: -35px;
			}
			
			.mui-table-view-chevron .mui-table-view-cell {
				padding-right: 35px;
			}
			
			.mui-popover-bottom li {
				height: 0.8rem;
				line-height: 0.8rem;
				font-size: 0.32rem;
			}
			
			.img_plus {
				margin-left: 10px;
				height: 14px;
				width: 14px;
				cursor: pointer;
			}
			
			.option_select {
				border: 1px solid rgba(0, 0, 0, .2) !important;
				height: 40px;
				width: 30%;
				padding: 0;
				margin: 0;
				font-size: 15px;
			}
			
			.content_input {
				margin: 0;
				margin-left: 5px;
				width: 60% !important;
				font-size: 14px;
			}
		</style>

	</head>

	<body>
		<header class="mui-bar mui-bar-nav titleheader">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">写字楼信息</h1>
			<a class="mui-pull-right history" onclick="findBuilding();">保存</a>
		</header>

		<div style="margin-top: 1.1rem;" id="building_div">
			<ul class="mui-table-view mui-table-view-chevron ul_interval">
				<li id="province" class="mui-table-view-cell select_li">
					<a>
						<label><font style="color:red">*</font>省份</label>
						<input type="text" id="province_in" name="province_in" placeholder="请选择" readonly />
						<input type="hidden" id="province_text" name="province_text" />
					</a>
				</li>
				<li id="city" class="mui-table-view-cell select_li">
					<a>
						<label><font style="color:red">*</font>城市</label>
						<input type="text" id="city_in" name="city_in" placeholder="请选择" readonly />
						<input type="hidden" id="city_text" name="city_text" />
					</a>
				</li>
				<li id="county" class="mui-table-view-cell select_li">
					<a class="mui-navigate-right">
						<label><font style="color:red">*</font>区县</label>
						<input type="text" id="county_in" name="county_in" placeholder="请选择" readonly />
						<input type="hidden" id="county_text" name="county_text" />
					</a>
				</li>
				<li id="street" class="mui-table-view-cell select_li">
					<a class="mui-navigate-right">
						<label><font style="color:red">*</font>街道</label>
						<input type="text" id="street_in" name="street_in" placeholder="请选择" readonly />
						<input type="hidden" id="street_text" name="street_text" />
					</a>
				</li>
				<li id="village" class="mui-table-view-cell select_li">
					<a class="mui-navigate-right">
						<label><font style="color:red">*</font>社区</label>
						<input type="text" id="village_in" name="village_in" placeholder="请选择" readonly />
						<input type="hidden" id="village_text" name="village_text" />
					</a>
				</li>
				<li class="mui-table-view-cell input_li">
					<div class="input-row">
						<label><font style="color:red">*</font>具体地址</label>
						<input type="text" id="address" name="address" placeholder="例：南十里居41号院1号楼" />
					</div>
				</li>
				<li class="mui-table-view-cell input_li">
					<div class="input-row">
						<label><font style="color:red">*</font>写字楼名称</label>
						<input type="text" id="building_name" name="building_name" placeholder="例：安泰大厦" />
						<input type="hidden" id="building_id" name="building_id" />
					</div>
				</li>
				<li id="building_level_li" class="mui-table-view-cell select_li">
					<a class="mui-navigate-right">
						<label><font style="color:red">*</font>写字楼级别/物业类型</label>
						<input type="text" id="building_level" name="building_level" placeholder="请选择" readonly style="width: 40%;" />
					</a>
				</li>

				<li class="mui-table-view-cell input_li_suffix">
					<div class="input-row-suffix">
						<label>写字楼建筑面积</label>
						<label class="suffix">m²</label>
						<input type="number" pattern="\d*" id="building_area" name="building_area" bidTableFlag="true" onkeyup="value=this.value.replace(/\D+/g,'')">
					</div>
				</li>
				<li class="mui-table-view-cell input_li_suffix">
					<div class="input-row-suffix">
						<label>层数</label>
						<input type="number" pattern="\d*" id="floor_num" name="floor_num" bidTableFlag="true" onkeyup="value=this.value.replace(/\D+/g,'')">
					</div>
				</li>
				<li class="mui-table-view-cell input_li_suffix">
					<div class="input-row-suffix">
						<label>停车位</label>
						<input type="number" pattern="\d*" id="parking_space" name="parking_space" bidTableFlag="true" onkeyup="value=this.value.replace(/\D+/g,'')">
					</div>
				</li>

				<li class="mui-table-view-cell input_li_suffix" id="building_li" style="margin-bottom: 1rem;">

				</li>

			</ul>
			<button id="btnRelation" class="add_btn" style="position: fixed; bottom:0.1rem; height: 0.8rem; right: 0.3rem;left: 0.3rem;background-color: #fff; z-index: 1000000;display: none;">
					<span class="mui-icon mui-icon-plusempty"></span>
								入驻公司信息
				</button>
		</div>
	</body>
	<script type="text/javascript" src="../js/mui.min.js"></script>
	<script type="text/javascript" src="../js/jquery-2.2.2.min.js"></script>
	<script type="text/javascript" src="../js/custom_jquery_based.js"></script>
	<script type="text/javascript" src="../js/custom_common.js"></script>
	<script type="text/javascript" src="../js/date_util.js"></script>
	<script type="text/javascript" src="../js/mui.picker.js"></script>
	<script type="text/javascript" src="../js/mui.picker.min.js"></script>
	<script type="text/javascript" src="../js/mui.poppicker.js"></script>
	<script type="text/javascript" src="../js/dict.js"></script>
	<script type="text/javascript" src="../js/cityObject.js"></script>
	<script type="text/javascript" src="../js/newcityObject.js"></script>
	<script type="text/javascript" type="text/javascript">
		var cityPicker = new mui.PopPicker();
		var provincePicker = new mui.PopPicker();
		var countyPicker = new mui.PopPicker();
		var streetPicker = new mui.PopPicker();
		var villagePicker = new mui.PopPicker();
		var two_levelPicker = new mui.PopPicker();
		var three_levelPicker = new mui.PopPicker();
		var five_levelPicker = new mui.PopPicker();
		var streetDictArray = null;
		var default_city = null;
		var provinceDictArray = null;
		var cityDictArray = null;
		var countyDict = null;
		var streetDict = null;
		var store = JSON.parse(localStorage.getItem('store'));
		//      var countyDict = new cityObject('county','county_text','county_in','city_text','CountyManager','getCountyDataByCityID','county_id','county_name',county_refresh);
		//      var streetDict = new cityObject('street','street_text','street_in','county_text','TownManager','getTownDataByCountyID','town_id','town_name',street_refresh);
		var villageDict = new cityObject('village', 'village_text', 'village_in', 'street_text', 'VillageManager', 'getVillageDataByTownId', 'village_id', 'village_name', village_refresh);

		var province_id = null;
		var city_id = null;
		var county_id = null;
		var street_id = null;
		var village_id = null;
		var two_level_id = null;
		var three_level_id = null;
		var four_level_id = null;
		var five_level_id = null;
		var employee = JSON.parse(localStorage.getItem('employee'));
		mui.plusReady(function() {
			if(plus.device.model == "iPhone10,3" || plus.device.model == "iPhone10,6" || plus.device.model == "iPhone11,8" || plus.device.model == "iPhone11,2" || plus.device.model == "iPhone11,6") {
				document.getElementById("building_div").style.marginTop = '1.5rem';
				document.getElementById("btnRelation").style.bottom = '34px';
			}
			ininView();

			document.getElementById('street_in').addEventListener('blur', function(event) {
				findBuildingData();
			});
			document.getElementById('building_name').addEventListener('blur', function(event) {
				findBuildingData();
			});
		});

		function ininView() {
			var self = plus.webview.currentWebview();
			if(self != null && self.building != null) {
				building = JSON.parse(self.building);
				setBuildingInfo(building);
			} else {
				$('#btnRelation').css('display', '');
				default_city = JSON.parse(localStorage.getItem('default_city'));
				if(default_city != null || default_city != "") {
					if(default_city.pro_name != null || default_city.pro_name != "") {
						$('#province_in').val(default_city.pro_name);
						$('#province_text').val(default_city.pro_id);
						province_id = $('#province_text').val();
					}
					if(default_city.city_name != null || default_city.city_name != "") {
						$('#city_in').val(default_city.city_name);
						$('#city_text').val(default_city.city_id);
						city_id = $('#city_text').val();
					}
					if(default_city.cou_name != null || default_city.cou_name != "") {
						$('#county_in').val(default_city.cou_name);
						$('#county_text').val(default_city.cou_id);
						county_id = $('#county_text').val();

					}

				}
				//				streetDictArray=getStreetData('street','street_text','street_in',store,'StoreManager','getStoreCityInfoById','id','name',street_refresh,streetPicker);
				countyDict = new newcityObject('county', 'county_text', 'county_in', 'city_text', store.store_id, 'CountyManager', 'findCountyDataByCityID', 'county_id', 'county_name', county_refresh)
				streetDict = new newcityObject('street', 'street_text', 'street_in', 'county_text', store.store_id, 'TownManager', 'getTownDataByCountyIDAndStoreId', 'town_id', 'town_name', street_refresh);
			}
			getBuildinglevelDict('building_level_li', 'building_level', [{
				text: '甲级'
			}, {
				text: '乙级'
			}, {
				text: '丙级'
			}, {
				text: '其它'
			}]);

			//	        countyDict.refresh();
			//			streetDict.refresh();
			villageDict.refresh();
			$(".add_btn").click(function() {

				addRow();
			});

		}

		//省份刷新
		function province_refresh() {
			province_follow_clean();
			province_id = $('#province_text').val();
			cityDictArray = getData('city', 'city_text', 'city_in', province_id, 'CityManager', 'getCityDataByProvinceID', 'city_id', 'city_name', city_refresh, cityPicker);
		}
		//城市刷新
		function city_refresh() {
			city_follow_clean();
			city_id = $('#city_text').val();
			countyDict.refresh();
		}
		//区县刷新
		function county_refresh() {
			county_follow_clean();
			streetDict.refresh();
		}
		//街道刷新
		function street_refresh() {
			street_follow_clean();
			villageDict.refresh();

		}
		//社区刷新
		function village_refresh() {}

		//清空省份以下显示数据
		function province_follow_clean() {
			$('#city_in').val("");
			$('#city_text').val("");
			city_follow_clean();
		}
		//清空城市以下显示数据
		function city_follow_clean() {
			$('#county_in').val("");
			$('#county_text').val("");
			county_follow_clean();
			countyDict.refresh();
		}
		//清空区县以下显示数据
		function county_follow_clean() {
			$('#street_in').val("");
			$('#street_text').val("");
			street_follow_clean();
			streetDict.refresh();
		}
		//清空街道以下显示数据
		function street_follow_clean() {
			$('#village_in').val("");
			$('#village_text').val("");
			villageDict.refresh();
		}
		//保存时先查询该写字楼是否存在
		function findBuilding() {
			var employee_name = employee.name;
			var employee_no = employee.employeeId;
			var employee_id = employee.id;
			var province_val = $("#province_in").val();
			var city_val = $("#city_in").val();
			var county_val = $("#county_in").val();
			var street_val = $("#street_in").val();
			var village_val = $("#village_in").val();
			var village_id = $("#village_text").val();
			var address_val = $("#address").val();
			var building_name_val = $("#building_name").val();
			var building_id_val = $("#building_id").val();

			var building_level_val = $("#building_level").val();
			var building_area_val = $("#building_area").val();
			var floor_num_val = $("#floor_num").val();
			var parking_space_val = $("#parking_space").val();
			var company_val = $("#company").val();
			var floor_val = $("#floor").val();
			var street_val = $('#street_text').val();

			var companyArray = new Array();
			var companyElementArray = $('#building_li').children('span');

			for(var i = 0; i < companyElementArray.length; i++) {
				var floor_company = $(companyElementArray[i]).find('.floor_company').val();
				var company_name = $(companyElementArray[i]).find('.company_name').val();
				var company_id = $(companyElementArray[i]).find('.company_id').val();

				var company = {
					office_floor_of_company: floor_company,
					office_company: company_name,
					company_id: company_id
				};
				companyArray.push(company);
			}

			if(!checkValue(province_val)) {
				mui.toast('请选择省份！');
				return;
			}
			if(!checkValue(city_val)) {
				mui.toast('请选择城市！');
				return;
			}
			if(!checkValue(county_val)) {
				mui.toast('请选择区县！');
				return;
			}
			if(!checkValue(street_val)) {
				mui.toast('请选择街道！');
				return;
			}
			if(!checkValue(village_val)) {
				mui.toast('请选择社区！');
				return;
			}
			if(!checkValue(address_val)) {
				mui.toast('请输入具体地址！');
				return;
			}
			if(!checkValue(building_name_val)) {
				mui.toast('请输入写字楼名称！');
				return;
			}
			if(!checkValue(building_level_val)) {
				mui.toast('请选择写字楼级别/物业类型！');
				return;
			}
			if(companyElementArray.length != 0) {
				if(!checkValue(company_name)) {
					mui.toast('请填写入驻公司名称！');
					return;
				}
			}

			var Office = {
				town_id: street_val,
				village_id: village_id,
				office_name: building_name_val,
				office_address: address_val,
				office_type: building_level_val,
				office_area: building_area_val,
				office_floor: floor_num_val,
				office_parking: parking_space_val,
				office_id: building_id_val,
				create_user: employee_name,
				employee_no: employee_no,
				create_user_id: employee_id
			};
			Office.company = companyArray;
			doManager('OfficeManager', 'getOfficeByOfficeAddressnamedata', Office, function(data) {
				if(data.result == true) {
					var jsonData = JSON.parse(data.data);
					if(jsonData.code == 200) {
						doSave(Office);
					} else if(jsonData.code == 300) {
						var btnArray = ['否', '是'];
						mui.confirm('该数据已存在！确定要覆盖吗？', '提示', btnArray, function(e) {
							if(e.index == 1) {
								doSave(Office);
							}
						});
					} else {
						mui.toast('保存失败');
					}

				} else {
					mui.toast('保存失败');
				}
			});

		}
		//保存
		function doSave(Office) {

			doManager('OfficeManager', 'save_OfficeData', Office, function(data) {
				if(data.result == true) {
					var jsonData = JSON.parse(data.data);
					if(jsonData.code == 200) {
						mui.toast('保存成功');
						setTimeout(function() {
							closeMenu();
						}, 500);
					} else {
						mui.toast('保存失败');
					}

				} else {
					mui.toast('保存失败');
				}
			});

		}

		function closeMenu() {
			var _current = plus.webview.currentWebview();
			var main = _current.opener();
			mui.fire(main, "setbuildinginput", {
				building: {
					building_name: $('#building_name').val(),
					building_address: $('#address').val()
				}
			});

			_current.close();
		}
		//添加入驻公司信息
		function addRow(company) {
			if(typeof(company) == 'undefined') {
				company = {
					office_floor_of_company: '',
					office_company: '',
					company_id: '',
					office_id: ''
				};
			}
			var $li = $('#building_li');
			var html = '<span style="overflow: hidden;clear: both;">' +
				'<input type="tel" pattern="\d*"  class="floor_company" name="floor_company" onkeyup="this.value=check_validate1(this.value)" value="' + company.office_floor_of_company + '"  placeholder="楼层" style="width:30%;float: left;">' +
				'<input type="text" class="company_name" name="company_name"   value="' + company.office_company + '" placeholder="入驻公司名称" style="width:60% ;float: left;">' +
				'<input type="hidden" class="company_id" name="company_id" value="' + company.company_id + '"  />' +
				'<input type="hidden" class="office_id" name="office_id" value="' + company.office_id + '"  />' +
				'<img src="../images/minus_16px.png" id="remove_piv" style="float: right;margin-top:10px"/>' +
				'</span>'

			$li.append(html);
			if(company.office_floor_of_company == "" | company.office_floor_of_company == null) {
				var div = document.getElementById('building_div');
				window.scrollTo(0, div.scrollHeight);
			}
			var $current_span = $li.find('span:last');
			var $img_minus = $current_span.find('#remove_piv:last');
			$img_minus.click(function() {
				$current_span.remove();
			});
		}
		//js正则判断input只能输入数字
		function check_validate1(value) {
			return value.replace(/\D+/g, '');
		}

		function setBuildingInfo(building) {
			$('#province_in').val(building.province_name);
			$('#province_text').val(building.province_id);

			$('#city_in').val(building.city_name);
			$('#city_text').val(building.city_id);

			$('#county_in').val(building.county_name);
			$('#county_text').val(building.county_id);

			$('#street_in').val(building.town_name);
			$('#street_text').val(building.town_id);

			$('#village_in').val(building.village_name);
			$('#village_text').val(building.village_id);

			$('#address').val(building.office_address);
			$('#building_name').val(building.office_name);
			$('#building_id').val(building.office_id);
			$('#building_level').val(building.office_type);
			$('#building_area').val(building.office_area);
			$('#floor_num').val(building.office_floor);
			$('#parking_space').val(building.office_parking);
			$('#county').find('a').removeAttr('class');
			var li2 = document.getElementById("county");
			li2.id = "countytttt";
			$('#street').find('a').removeAttr('class');
			var li1 = document.getElementById("street");
			li1.id = "streetttt";
			$(building.company).each(function(i, company) {
				addRow(company);
			});

		}
		//新建写字楼信息如果存在自动带出
		function findBuildingData() {
			var building_params = {
				office_name: $('#building_name').val(),
				town_id: $('#street_text').val()
			};
			if(building_params.office_name != null && building_params.office_name != '' &&
				building_params.town_id != null && building_params.town_id != '') {
				doManager('OfficeManager', 'findOfficeByOfficeAddressandnamedata', building_params, function(data) {
					if(data.result) {
						var jsonData = JSON.parse(data.data);
						if(jsonData.listOffice != null) {
							$(jsonData.listOffice).each(function(index, building) {
								setBuildingInfo(building);
							});
						}

					}
				});
			}

		}
	</script>

</html>