<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>拜访记录详情页面</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<!--标准mui.css-->
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" type="text/css" href="../css/common.css" />
		<link rel="stylesheet" type="text/css" href="../css/style.css" />
		<link rel="stylesheet" type="text/css" href="../css/express.css" />
		<link href="../css/mui.picker.css" rel="stylesheet" />
		<link href="../css/mui.poppicker.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/mui.picker.min.css" />
		<link href="../css/visiting_record.css" rel="stylesheet" />
		
		<style>
			.mui-popover-bottom li{height: 0.8rem; line-height: 0.8rem; font-size: 0.32rem;}
			.img_plus{margin-left: 10px;height: 14px;width: 14px;cursor: pointer;}
			.img_minus{margin-left: 5px;height: 14px;width: 14px;cursor: pointer;}
			.option_select{border: 1px solid rgba(0,0,0,.2) !important;height:40px;width: 30%;padding: 0;margin: 0;font-size: 15px;}
			.content_input{margin: 0;margin-left: 5px;width: 60% !important;font-size: 14px;}
			.more_information{
				width:100%; height: 0.7rem;color:#fff;font-size: 0.32rem;background-color: #e66629; text-align: center; margin-top: 0.4rem;border-radius: 0.1rem;
			}
            .new_option_select{border: 0px solid rgba(0,0,0,.2) !important;height:40px;width: 30%;padding: 0;margin: 0;font-size: 15px;}  
            .new_content_input{margin: 0;margin-left: 5px;width: 60% !important;font-size: 14px;border: 0px solid rgba(0,0,0,.2) !important;}
		</style>
		
	</head>

	<body>
	
		<header class="mui-bar mui-bar-nav titleheader">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">拜访记录</h1>
			<a class="mui-pull-right history" onclick="doSubmit();">保存</a>
		</header>
		<div id="div_info" class="mui-content" style="margin-bottom: 0.3rem;">
			<div id="item1" style="padding-top: 8px" class="mui-control-content mui-active">
				<ul class="mui-table-view mui-table-view-chevron ul_interval">
					<li class="mui-table-view-cell input_li">
						<div class="input-row">
							<label>姓名<font style="color:red">*</font></label>
							<input type="hidden" id="id" name="id" readonly="readonly">
							<input type="hidden" id="create_user_id" name="create_user_id" readonly="readonly">
							<input type="hidden" id="create_user" name="create_user" readonly="readonly">
							<input type="text" id="name" name="name">
						</div>
					</li>
					<li class="mui-table-view-cell input_li">
						<div class="input-row">
							<label>电话<font style="color:red">*</font></label>
							<input type="tel" id="mobilephone" name="mobilephone" placeholder="11位电话号码或手机" maxlength="11" onkeyup="value=this.value.replace(/\D+/g,'')">
						</div>
					</li>
					<li class="mui-table-view-cell radio_li">
						<div class="input-row-suffix mui-radio">
							<label>性别</label>
							<div style="float: right;">
								<input id="man" name="sex" type="radio" style="float: initial;" value="0" checked > 男
								<input id="wuman" name="sex" type="radio" style="float: initial;" value="1" > 女
							</div>
						</div>
					</li>
					<li class="mui-table-view-cell radio_li">
						<div class="input-row-suffix mui-radio">
							<label>房屋类型</label>
							<div style="float: right;">
								<input id="house" name="house_type" type="radio" style="float: initial;" bidTableFlag="true" value="0" > 平房
								<input id="building" name="house_type" type="radio" style="float: initial;" bidTableFlag="true" value="1" checked> 楼房
							</div>
						</div>
					</li>
					<li id="li_house_address" class="mui-table-view-cell select_li">
						<input type="hidden" id="house_id" name="house_id" bidTableFlag="true">
						<a id="a_address" class="mui-navigate-right">
							<label>地址</label>
							<input id="address" name="address" type="text" placeholder="请填写" readonly="readonly">
						</a>
					</li>
					
				</ul>
			    <div id="item4" style="margin-bottom: 1rem;">
					
				</div>
				<div class="add_btn" style="position: fixed; bottom: 0; height: 0.8rem;"  id="add_btn">
						<button id="btnRelation">
							<span class="mui-icon mui-icon-plusempty"></span>
							个人拜访信息
						</button>
						<button id="btnStoreRelation">
							<span class="mui-icon mui-icon-plusempty"></span>
							商户拜访信息
						</button>
					</div>
			</div>
		</div>
		
	</body>
	<script type="text/javascript" src="../js/mui.min.js"></script>
	<script type="text/javascript" src="../js/jquery-2.2.2.min.js"></script>
	<script type="text/javascript" src="../js/custom_jquery_based.js"></script>
	<script type="text/javascript" src="../js/custom_common.js"></script>
	<script type="text/javascript" src="../js/date_util.js"></script>
	<script type="text/javascript" src="../js/mui.picker.js"></script>
	<script type="text/javascript" src="../js/mui.picker.min.js"></script>
	<script type="text/javascript" src="../js/mui.poppicker.js"></script>
	<script type="text/javascript" src="../js/dict.js"></script>
	<script type="text/javascript" type="text/javascript">
		var employeePicker = new mui.PopPicker();
		var typePicker = new mui.PopPicker();
        
		var employee = JSON.parse(localStorage.getItem('employee'));
		var store = JSON.parse(localStorage.getItem('store'));
	    var dict_relation_content_resource = JSON.parse(localStorage.getItem('relation_content_resource'));
    	var dict_relation_content_option_resource = JSON.parse(localStorage.getItem('relation_content_option_resource'));
		var self =null;
		var havetob=false;
		var obj_addressCustomer = null;
		var isOnclick=true;
		//个人拜访是否是第一次点击
		var isOneClick=false;
		var isTobClick=false;
		var isTobTOClick=false;
		var istoClick=false;
		
		
		window.addEventListener('getHouse_id',function(event){
			obj_addressCustomer = event.detail.address_customer;
		
			var address = obj_addressCustomer.tv_name 
				+ obj_addressCustomer.building_name + "号楼";
				if(obj_addressCustomer.house_type == 1){
					address += obj_addressCustomer.unit_no
							+ "单元" + obj_addressCustomer.house_no + "号";
				}
				
			$('#house_id').val(obj_addressCustomer.house_id);
			$('#address').val(address);
			//根据房屋id获取户型对象
			doManager('HouseStyleManager','getHouseStyleByHouseId',obj_addressCustomer.house_id,function(data){
				if(data.result){
					obj_addressCustomer.house_style = data.house_style;
					obj_addressCustomer.house_pic = data.house_pic;
					obj_addressCustomer.house_toward = data.house_toward;
					obj_addressCustomer.house_area = data.house_area;
					obj_addressCustomer.house_style_id = data.id;
				
				}
			});
		});
			
		mui.plusReady(function() {
			if(plus.device.model == "iPhone10,3"||plus.device.model == "iPhone10,6"|| plus.device.model == "iPhone11,8"||plus.device.model == "iPhone11,2"||plus.device.model == "iPhone11,6") {
					document.getElementById("add_btn").style.bottom='34px';
					}
			mui.init();
			if(mui.os.ios) {
				$('.div_bottom').css('margin-bottom', '0.3rem');
				$('.mui-content').css('margin-bottom', '0.2rem');
			}


			
			typePicker.setData([{
				text: '电话'
			}, {
				text: '微信'
			}, {
				text: '客户到店'
			},{
				text: '面对面(上门)'
			}, {
				text: '面对面(混片儿)'
			}, {
				text: '其他'
			}]);
			var self = plus.webview.currentWebview();
			if(self != null && self.customer != null) {
				customer = JSON.parse(self.customer);
				istoClick=true;
				isTobTOClick=true;
				setCustomer(customer);
			}
			if(obj_addressCustomer == null){ 
				obj_addressCustomer = {house_type:1};
			}
			//国安侠选择
			initEmployeeSelect();
			document.getElementById('name').addEventListener('blur', function(event) {
				findCustomer();
			});

			document.getElementById('mobilephone').addEventListener('blur', function(event) {
				findCustomer();
			});
			document.getElementById('btnRelation').addEventListener('tap', function(event) {
				
				var user_name=$('#name').val();
			    var user_phone=$('#mobilephone').val();
				if(!checkValue_(user_name)){
					mui.toast("没有拜访用户，请填写拜访用户姓名。");
					return;
				}
				if(!checkValue_(user_phone)){
					mui.toast("没有拜访用户电话，请填写拜访用户电话。");
					return;
				}
				if(!/^\d{11}$/.test(user_phone)) {
					mui.toast("请输入正确的电话号码。");
					return;
			    }
				setTimeout(function(){
				addRelation();
				},500);
				
				
				isOneClick=true;
			});
			
			document.getElementById('btnStoreRelation').addEventListener('tap', function(event) {
				var user_name=$('#name').val();
			    var user_phone=$('#mobilephone').val();
				if(!checkValue_(user_name)){
					mui.toast("没有拜访用户，请填写拜访用户姓名。");
					return;
				}
				if(!checkValue_(user_phone)){
					mui.toast("没有拜访用户电话，请填写拜访用户电话。");
					return;
				}
				if(!/^\d{11}$/.test(user_phone)) {
					mui.toast("请输入正确的电话号码。");
					return;
			    }
				if(havetob){
					addStoreRelation();
					var div = document.getElementById('div_info');
			        window.scrollTo(0,div.scrollHeight);
				}else{
					mui.toast("此用户无对应的商业信息!请到Web端街道、社区、小区、商业信息页面维护负责人信息！ ");
				}
//				isTobClick=true;
			});
			document.getElementById('a_address').addEventListener('tap', function(event) {
				var str_name=$("#name").val();
				var phone=$("#mobilephone").val();
				if(!checkValue_(str_name)){
					mui.toast('请填写用户姓名！');
					return;
				}
				if(!checkValue_(phone)){
					mui.toast('请填写电话！');
					return;
				}
				setTimeout(function(){
					if(isOnclick){
					isOnclick = false;
					toSelectHose();
				}
				},1000);
				
				
			});
			
			$('input[name="house_type"]').change(function() {
				var house_type = $('input[name="house_type"]:checked').val();
				if(house_type == 0){
					obj_addressCustomer.house_type = 0;
					$('#address').val("");
					obj_addressCustomer.house_id=null;
					obj_addressCustomer.building_id=null;
					obj_addressCustomer.tv_id=null;
				}else{
					obj_addressCustomer.house_type = 1;
					$('#address').val("");
					obj_addressCustomer.house_id=null;
					obj_addressCustomer.building_id=null;
					obj_addressCustomer.tv_id=null;
				}
			});
			
		});
		
		function setCustomer(customer){
			isOnclick=false;
			$('#a_address').removeClass('mui-navigate-right')
			$("#name").attr("readonly", "readonly");
			$("#mobilephone").attr("readonly", "readonly");
			$("#man").attr("disabled", true);
			$("#wuman").attr("disabled", true);
			$("#house").attr("disabled", true);
			$("#building").attr("disabled", true);
			$("#address").attr("readonly", "readonly");
			setFormSimpleData(customer);
			if($('#address').val()==null||$('#address').val()==''){
				$('#address').val("暂无地址信息");
			}
			document.getElementById("name").style.color="#CCCCCC";
			document.getElementById("mobilephone").style.color="#CCCCCC";
			document.getElementById("address").style.color="#CCCCCC";
		  	isTo_B(customer.id);
		  	$('input[name="sex"][value="' + customer.sex + '"]').attr('checked', 'checked');
		  	if(customer.customer_address != null){
		    	$('input[name="house_type"][value="' + customer.customer_address.house_type + '"]').attr('checked', 'checked');
		  	}
		  	var $rels = $(customer.relations);
			$rels.sort(function(obj1,obj2){
				return obj2.relation_date-obj1.relation_date;
			});
			
			
			$rels.each(function(i, relation) {
				if(relation.customer_type=="1"){
					addNewStoreRelation(relation);
				}else{
					addNewRelation(relation);
				}
				
				
			});
			 var $html = $(".user_type_layout");
			 $html.each(function(){
			 	var liobj = $(this).find('li');
			 	if(liobj.length==0){
			 		$(this).remove();
			 	}
			 });
//			 if(istoClick){
//			 	document.getElementById('btnRelation').addEventListener('tap', function(event) {
//			 		var user_name=$('#name').val();
//				    var user_phone=$('#mobilephone').val();
//					if(!checkValue_(user_name)){
//							mui.toast("没有拜访用户，请填写拜访用户姓名。");
//							return;
//					}
//					if(!checkValue_(user_phone)){
//							mui.toast("没有拜访用户电话，请填写拜访用户电话。");
//							return;
//							
//					}
//			 		alert("2***********");
//					addRelation();
//					var div = document.getElementById('div_info');
//			        window.scrollTo(0,div.scrollHeight);
//			        istoClick=false;
//				});
//			 }
//			 if(isTobTOClick){
//			 	document.getElementById('btnStoreRelation').addEventListener('tap', function(event) {
//				if(havetob){
//					addStoreRelation();
//					var div = document.getElementById('div_info');
//			        window.scrollTo(0,div.scrollHeight);
//				}else{
//					mui.toast("此用户无对应的商业信息!请到Web端街道、社区、小区、商业信息页面维护负责人信息！ ");
//				}
//				
//			  });
//			 	isTobTOClick=false;
//			 }
			 
			
		
		}
		function addRelation(relation) {
			var isedit = false;
			if(typeof(relation) == 'undefined') {
				isedit = true;
				 relation = {
	                id:'',
	                employee_no:employee.employeeId,
	                employee_name:employee.name,
                 	relation_type:'',
	                relation_date:new Date().Format('YYYY-MM-dd'),
					childs:[]
	            }
			}else{
				relation.relation_date = new Date(relation.relation_date).Format('YYYY-MM-dd');
			}
			var $div_parent = $('#item4');
//			var $div_btn = $div_parent.find('.add_btn');
			var html = '<ul class="mui-table-view mui-table-view-chevron ul_interval ssssss">'+
					   '<li class="mui-table-view-cell select_li emp">'+
					   '<a class="mui-navigate-right" href="#">'+
					   '<label>拜访国安侠</label>'+
					   '<input type="hidden" name="relation_id" value="'+relation.id+'" bidtableflag="true">'+
					   '<input type="hidden" name="employee_no" value="'+relation.employee_no+'" bidtableflag="true">'+
					   '<input type="text" name="employee_name" placeholder="请选择" value="'+relation.employee_name+'" bidtableflag="true" readonly>'+
					   '</a>'+
					   '</li>'+
					   
   					   '<li class="mui-table-view-cell select_li type">'+
					   '<a class="mui-navigate-right" href="#">'+
					   '<label>拜访方式<font style="color:red">*</font></label>'+
					   '<input type="text" name="relation_type" placeholder="请选择" value="'+(relation.relation_type == null?'':relation.relation_type)+'" bidtableflag="true" readonly>'+
					   '</a>'+
					   '</li>'+
					   
				   	   '<li class="mui-table-view-cell select_li date">'+
					   '<a class="mui-navigate-right" href="#">'+
					   '<label>拜访时间</label>'+
					   '<input type="text" name="relation_date" placeholder="请选择" value="'+relation.relation_date+'" bidtableflag="true" readonly>'+
					   '</a>'+
					   '</li>';
					   html+= (isedit == true?'<li class="mui-table-view-cell input_li" style="text-align: right;"><button class="btnDelete">删除</button></li>':'')+
					   '</ul>';
					   
			$div_parent.append(html);
			var $ul = $div_parent.find('ul:last');
			var $li_date = $ul.find('.date');
			var $ul_content = $div_parent.find('ul:last');
    		if(dict_relation_content_resource != null){
				dict_relation_content_resource.sort(function(a,b){
	                return b.dictCode-a.dictCode
	            });
    		}
    		
			$(dict_relation_content_resource).each(function(index,element){
	            $li_date.after('<li class="mui-table-view-cell user_type_layout"  style="padding-right: 0;">'+
	            		'<label>'+element.dictText+'</label>'+
	            		(isedit == true?'<img src="../images/badge_plus_16px.png" class="img_plus"/>':'')+
	            		'<input type="hidden" name="dictCode" value="'+element.dictCode+'" bidtableflag="true"/><ul></ul></li>');
				var $li_content = $li_date.next('li');
				var $option_ul = $li_content.find('ul');
	 			$(relation.childs).each(function(i,content){
	                if(content.content_code != element.dictCode){
	                    return;
	                }
	                addRow($option_ul,isedit,element.dictCode,content);
	           });
	            if(isedit){
	            	var $img = $li_content.find('.img_plus:last');
	                $img.click(function(){
	                    var dcode = $img.next('input').val();
	                    addRow($option_ul,isedit,dcode,null,null);
	                });
	            }
	        });
	        
	        if(isedit){
				$ul_content.find('.emp')[0].addEventListener('tap',function(event){
					var $input_name = $(this).find('input[name="employee_name"]');
					var $input_no = $(this).find('input[name="employee_no"]');
					employeePicker.show(function(items) {
						$input_name.val(items[0].text);
						$input_no.val(items[0].value);
					});
				});
				
				$ul_content.find('.type')[0].addEventListener('tap',function(event){
					var $input_type = $(this).find('input[name="relation_type"]');
					typePicker.show(function(items) {
						$input_type.val(items[0].text);
					});
				});
	
				$ul_content.find('.date')[0].addEventListener('tap', function() {
					var today = new Date();
					var datePicker = new mui.DtPicker({type:"date",beginDate: new Date(today.getFullYear(), today.getMonth()),endDate:new Date()});
					var input_relation_date = $(this).find('input[name="relation_date"]')[0];
						datePicker.show(function(rs) {
							input_relation_date.value = rs.text;
							datePicker.dispose();
						});
					}, false);
				$ul_content.find('.btnDelete').click(function(){
					var btnArray = ['否','是'];
					mui.confirm('确认删除吗？', '提示', btnArray, function(e) {
						if (e.index == 1) {
							$ul_content.remove();
						}
					});	
					
				});
			}
	        var div = document.getElementById('div_info');
			window.scrollTo(0,div.scrollHeight);
		}
		
		function addStoreRelation(relation) {
			var isedit = false;
			if(typeof(relation) == 'undefined') {
				isedit = true;
				 relation = {
	                id:'',
	                employee_no:employee.employeeId,
	                employee_name:employee.name,
                 	relation_type:'',
	                relation_date:new Date().Format('YYYY-MM-dd'),
					childs:[]
	            }
			}else{
				relation.relation_date = new Date(relation.relation_date).Format('YYYY-MM-dd');
			}
			var $div_parent = $('#item4');
//			var $div_btn = $div_parent.find('.add_btn');
			var html = '<ul class="mui-table-view mui-table-view-chevron ul_interval">'+
					   '<li class="mui-table-view-cell select_li emp">'+
					   '<a class="mui-navigate-right" href="#">'+
					   '<label>拜访国安侠</label>'+
					   '<input type="hidden" name="relation_id" value="'+relation.id+'" bidtableflag="true">'+
					   '<input type="hidden" name="employee_no" value="'+relation.employee_no+'" bidtableflag="true">'+
					   '<input type="text" name="employee_name" placeholder="请选择" value="'+relation.employee_name+'" bidtableflag="true" readonly>'+
					   '</a>'+
					   '</li>'+
					   
   					   '<li class="mui-table-view-cell select_li type">'+
					   '<a class="mui-navigate-right" href="#">'+
					   '<label>拜访方式<font style="color:red">*</font></label>'+
					   '<input type="text" name="relation_type" placeholder="请选择" value="'+(relation.relation_type == null?'':relation.relation_type)+'" bidtableflag="true" readonly>'+
					   '</a>'+
					   '</li>'+
					   
				   	   '<li class="mui-table-view-cell select_li date">'+
					   '<a class="mui-navigate-right" href="#">'+
					   '<label>拜访时间</label>'+
					   '<input type="text" name="relation_date" placeholder="请选择" value="'+relation.relation_date+'" bidtableflag="true" readonly>'+
					   '</a>'+
					   '</li>'+
					   '<li class="mui-table-view-cell input_li reason">'+
					   '<div class="input-row">' +
					   '<label>拜访事由<font style="color:red">*</font></label>'+
					   '<input type="text" id="relation_reason" name="relation_reason" value="'+(relation.relation_reason == null?'':relation.relation_reason)+'" bidtableflag="true"'+
            				(isedit == true?'':'disabled')+' >'+
					   '<input type="hidden"  id="customer_type" value="1"/>'+
						'</div>'+
					   '</li>' + 
					    
					   '<li class="mui-table-view-cell input_li feedback_">'+
					   '<div class="input-row">' +
					   '<label>反馈<font style="color:red">*</font></label>'+
					   '<input type="text" id="relation_rcv" name="relation_rcv" value="'+(relation.relation_rcv == null?'':relation.relation_rcv)+'" bidtableflag="true"'+
            				(isedit == true?'':'disabled')+'  >'+
						'</div>'+
					   '</li>';
					   html+= (isedit == true?'<li class="mui-table-view-cell input_li" style="text-align: right;"><button class="btnDelete">删除</button></li>':'')+
					   '</ul>';
					   
			$div_parent.append(html);
			var $ul = $div_parent.find('ul:last');
			var $li_date = $ul.find('.date');
			var $ul_content = $div_parent.find('ul:last');
	        
	        
	        if(isedit){
				$ul_content.find('.emp')[0].addEventListener('tap',function(event){
					var $input_name = $(this).find('input[name="employee_name"]');
					var $input_no = $(this).find('input[name="employee_no"]');
					employeePicker.show(function(items) {
						$input_name.val(items[0].text);
						$input_no.val(items[0].value);
					});
				});
				
				$ul_content.find('.type')[0].addEventListener('tap',function(event){
					var $input_type = $(this).find('input[name="relation_type"]');
					typePicker.show(function(items) {
						$input_type.val(items[0].text);
					});
				});
	
				$ul_content.find('.date')[0].addEventListener('tap', function() {
					var today = new Date();
					var datePicker = new mui.DtPicker({type:"date",beginDate: new Date(today.getFullYear(), today.getMonth()),endDate:new Date()});
					var input_relation_date = $(this).find('input[name="relation_date"]')[0];
						datePicker.show(function(rs) {
							input_relation_date.value = rs.text;
							datePicker.dispose();
						});
					}, false);
				$ul_content.find('.btnDelete').click(function(){
					var btnArray = ['否','是'];
					mui.confirm('确认删除吗？', '提示', btnArray, function(e) {
						if (e.index == 1) {
							$ul_content.remove();
						}
					});	
					
				});
			}
		}
		
		
		function addRow($ul,isedit,dictCode,content){
            if(content == null){
                content = {
                    id : '',
                    option_code : '',
                    content : ''
                };
            }
            var str_select_name = 'option'+dictCode;
            var str_input_name = 'input'+dictCode;

            var html = '<li><input type="hidden" name="content_id" value="'+content.id+'" bidtableflag="true">'+
            				'<select class="option_select" name="'+str_select_name+'" bidtableflag="true"'+
            				(isedit == true?'':'disabled')+' ></select>'+
            				'<input type="text" name="'+str_input_name+'" class="content_input" value="'+content.content+'" bidtableflag="true"'+
            				(isedit == true?'':'disabled')+' >'+
            				(isedit == true?'<img src="../images/minus_16px.png" class="img_minus"/>':'')+
            				'</li>';
		
            $ul.append(html);
            var $select_option = $ul.find('select[name="'+str_select_name+'"]:last'); 
            var $current_li = $ul.find('li:last');
            var first_code = null;
            $(dict_relation_content_option_resource).each(function(j,dict){
                if(dict.serialNumber == dictCode){
                	if(first_code == null){
                		first_code = dict.dictCode;
                	}
                    $select_option.append('<option value="'+dict.dictCode+'">'+dict.dictText+'</option>');
                }
            });
            if(isedit){
                var $img_minus = $current_li.find('.img_minus:last');
                $img_minus.click(function(){
                    $current_li.remove();
                });
            }

            if(content.option_code != ''){
                $select_option.val(content.option_code);
            }
        }
		//根据门店获取国安侠列表
		function initEmployeeSelect() {
            if(store==null){
            	var employeeData = new Array();
            	var employee_id=employee.employeeId;
            	if(employee.employeeId==null){
            		employee_id='';
            	}
            	
            	var itemData = {
					value: employee_id,
				    text: employee.name
				};
				employeeData.push(itemData);
				employeePicker.setData(employeeData);
            }else{
            	doManager('UserManager', 'findNamesBySid', store.store_id, function(data) {

					if(data.result == true) {
						var employeeData = new Array();
						var jsonData = JSON.parse(data.data);
						var iscontains=true;
						for(var index in jsonData.userList) {
							if(jsonData.userList[index].employeeId == employee.employeeId){
								iscontains=true;
								break;
							}else{
								iscontains=false;
							}
						}
	
						for(var index in jsonData.userList) {
								var itemData = {
									value: jsonData.userList[index].employeeId,
									text: jsonData.userList[index].name
							    };
							employeeData.push(itemData);
						}
						
						if(!iscontains){
							var itemData = {
								value: employee.employeeId,
								text: employee.name
						    };
						    employeeData.push(itemData);
						}
						employeePicker.setData(employeeData);
					}
			    });
            	
            }
			
			
		}

		function doSubmit() {
			var relationElementArray = $('#item4').children('ul');
			var relationArray = new Array();
			for(var i = 0;i < relationElementArray.length;i++){
				var str_id = $(relationElementArray[i]).find('input[name="relation_id"]').val();
				var str_employee_no = $(relationElementArray[i]).find('input[name="employee_no"]').val();
				var str_employee_name = $(relationElementArray[i]).find('input[name="employee_name"]').val();
				var str_relation_date = $(relationElementArray[i]).find('input[name="relation_date"]').val();
				var str_relation_type = $(relationElementArray[i]).find('input[name="relation_type"]').val();
				var str_relation_reason=$(relationElementArray[i]).find('input[name="relation_reason"]').val();
                var str_relation_rcv=$(relationElementArray[i]).find('input[name="relation_rcv"]').val();
                var str_customer_type=$(relationElementArray[i]).find('#customer_type').val();
                if(str_id !=null && str_id !=""){
                	continue;
                }
                    
				 var content_childs = [];
	            $(dict_relation_content_resource).each(function(index,element){
	                $(relationElementArray[i]).find('select[name="option'+element.dictCode+'"]').each(function(){
	                    var $current_li = $(this).parent();
	                    var str_content_id = $current_li.find('input[name="content_id"]').val();
	                    var str_content = $current_li.find('input[name="input'+element.dictCode+'"]').val();
	                    var str_option_code = $(this).find('option:selected').val();
	                    if(checkValue_(str_content)){
	                        var obj = {
	                            id:str_content_id,
	                            relation_id:str_id,
	                            content_code:element.dictCode,
	                            option_code:str_option_code,
	                            content:str_content
	                        }
	                        content_childs.push(obj);
	                    }
	                });
	            });
	            	if(!checkValue_(str_relation_type)) {
	                	isSaving = false;
		                mui.toast("请选择拜访方式。");
		                return;
		            }
		            if(str_customer_type==1){
		            	if(checkValue_(str_relation_type) && !checkValue_(str_relation_reason) ){
							isSaving = false;
							mui.toast("新的拜访事由记录内容不能为空。");
							return;
					    }else if(checkValue_(str_relation_type) && !checkValue_(str_relation_rcv)){
					    	isSaving = false;
					    	mui.toast("新的拜访反馈记录内容不能为空。");
							return;
					    }
		            }else{
		            	
		            	if(checkValue_(str_relation_type) && content_childs.length == 0){
							isSaving = false;
							mui.toast("新的拜访记录内容，最少填写一项。");
							return;
				     	}
		            	
		            }
				var relation = {
					id:str_id,
					employee_no: str_employee_no,
					employee_name: str_employee_name,
					relation_date: str_relation_date,
					relation_type:str_relation_type,
					relation_reason:str_relation_reason,
                    relation_rcv:str_relation_rcv,
                    customer_type:str_customer_type,
                    create_user_id :employee.id,
				    create_user : employee.name,
					childs:content_childs
				};
				relationArray.push(relation);
			}
			    var user_name=$('#name').val();
			    var user_phone=$('#mobilephone').val();
				if(!checkValue_(user_name)){
					mui.toast("没有拜访用户，请填写拜访用户姓名。");
					return;
				}
				if(!checkValue_(user_phone)){
					mui.toast("没有拜访用户电话，请填写拜访用户电话。");
					return;
				}
				if(!/^\d{11}$/.test(user_phone)) {
					mui.toast("请输入正确的电话号码。");
					return;
			    }
			if(relationArray.length == 0){
            	mui.toast("请添加新的拜访记录。");
            	return;
        	}
			
			
			var customer = getFormSimpleData('div_info');
			customer.relations = relationArray;
			
			if(customer.create_user_id == null){
				customer.create_user_id = employee.id;
				customer.create_user = employee.name;
			}
			customer.employee_no = employee.employeeId;
			customer.update_user_id = employee.id;
			customer.update_user = employee.name;
			if(checkValue_(customer.id)) {
				customer.update_user_id = employee.id;
				customer.update_user = employee.name;
			} else {
				customer.create_user_id = employee.id;
				customer.create_user = employee.name;
			}
			customer.customer_address = {
				house_type:$('input[name="house_type"]:checked').val(),
				house_id:$('#house_id').val()
			}
			doManager('CustomerManager', 'saveCustomerAndRelation', customer, function(data) {
				if(data.result){
					isSaving = false;
					var jsonData = JSON.parse(data.data);
						$('#id').val(jsonData.id);
						mui.toast('保存成功！');
						setTimeout(function(){
							closeMenu();
						},500)
						
				}else{
					isSaving = false;
					mui.toast('保存失败');
				}
			},true,function(){
				isSaving = false;
			});
			
		}
		
		function closeMenu(){
			
			var _current = plus.webview.currentWebview();
			var main = _current.opener();
			mui.fire(main,"setRelationText",{relation:{
				relation_name:$('#name').val(),
				relation_mobilephone:$('#mobilephone').val()
			}});
			_current.close();
		}
		function checkValue_(value){
			if(value == null || value == ''||value=='undefined'||value.toString().trim().length==0){
				return false;
			}
			return true;
		}
		function doBack(){
			var main = plus.webview.currentWebview().opener();
			main.evalJS('doback_true()');
			mui.back();
			
		}
		//查询是否是对商户拜访
		function isTo_B(customer_id){
			doManager('PersonDutyManager','findPersonDutyBycustomerId',[customer_id],function(data){
				if(data.result){
					var jsonData = JSON.parse(data.data);
					if(jsonData.length==0){
                	   havetob=false;
                    }else{
                    	havetob=true;
                    }
					
					
				}else{
					mui.toast(jsonData.message);
				}
				
			});
		}
		
		
		
		
		
		function addNewRelation(relation) {
			var isedit = false;
			if(typeof(relation) == 'undefined') {
				isedit = true;
				 relation = {
	                id:'',
	                employee_no:employee.employeeId,
	                employee_name:employee.name,
                 	relation_type:'',
	                relation_date:new Date().Format('YYYY-MM-dd'),
					childs:[]
	            }
			}else{
				relation.relation_date = new Date(relation.relation_date).Format('YYYY-MM-dd');
			}
			var $div_parent = $('#item4');
//			var $div_btn = $div_parent.find('.add_btn');
			var html = '<ul class="mui-table-view mui-table-view-chevron ul_interval">'+
					   '<li class="mui-table-view-cell select_li emp">'+
					   '<a>'+
					   '<label>拜访国安侠</label>'+
					   '<input type="hidden" name="relation_id" value="'+relation.id+'" bidtableflag="true">'+
					   '<input type="hidden" name="employee_no" value="'+relation.employee_no+'" bidtableflag="true">'+
					   '<input type="text" name="employee_name" placeholder="请选择" value="'+relation.employee_name+'" bidtableflag="true" readonly style="color:#CCCCCC">'+
					   '</a>'+
					   '</li>'+
					   
   					   '<li class="mui-table-view-cell select_li type">'+
					   '<a>'+
					   '<label>拜访方式<font style="color:red">*</font></label>'+
					   '<input type="text" name="relation_type" placeholder="请选择" value="'+(relation.relation_type == null?'':relation.relation_type)+'" bidtableflag="true" readonly style="color:#CCCCCC">'+
					   '</a>'+
					   '</li>'+
					   
				   	   '<li class="mui-table-view-cell select_li date">'+
					   '<a>'+
					   '<label>拜访时间</label>'+
					   '<input type="text" name="relation_date" placeholder="请选择" value="'+relation.relation_date+'" bidtableflag="true" readonly style="color:#CCCCCC">'+
					   '</a>'+
					   '</li>';
					   html+= (isedit == true?'<li class="mui-table-view-cell input_li" style="text-align: right;"><button class="btnDelete">删除</button></li>':'')+
					   '</ul>';
					   
			$div_parent.append(html);
			var $ul = $div_parent.find('ul:last');
			var $li_date = $ul.find('.date');
			var $ul_content = $div_parent.find('ul:last');
    		if(dict_relation_content_resource != null){
				dict_relation_content_resource.sort(function(a,b){
	                return b.dictCode-a.dictCode
	            });
    		}
    		
			$(dict_relation_content_resource).each(function(index,element){
	            $li_date.after('<li class="mui-table-view-cell user_type_layout"  style="padding-right: 0;">'+
	            		'<label>'+element.dictText+'</label>'+
	            		(isedit == true?'<img src="../images/badge_plus_16px.png" class="img_plus"/>':'')+
	            		'<input type="hidden" name="dictCode" value="'+element.dictCode+'" bidtableflag="true"/><ul></ul></li>');
				var $li_content = $li_date.next('li');
				var $option_ul = $li_content.find('ul');
	 			$(relation.childs).each(function(i,content){
	                if(content.content_code != element.dictCode){
	                    return;
	                }
	                NewAddRow($option_ul,isedit,element.dictCode,content);
	           });
	            if(isedit){
	            	var $img = $li_content.find('.img_plus:last');
	                $img.click(function(){
	                    var dcode = $img.next('input').val();
	                    NewAddRow($option_ul,isedit,dcode,null,null);
	                });
	            }
	        });
	        
	        if(isedit){
				$ul_content.find('.emp')[0].addEventListener('tap',function(event){
					var $input_name = $(this).find('input[name="employee_name"]');
					var $input_no = $(this).find('input[name="employee_no"]');
					employeePicker.show(function(items) {
						$input_name.val(items[0].text);
						$input_no.val(items[0].value);
					});
				});
				
				$ul_content.find('.type')[0].addEventListener('tap',function(event){
					var $input_type = $(this).find('input[name="relation_type"]');
					typePicker.show(function(items) {
						$input_type.val(items[0].text);
					});
				});
	
				$ul_content.find('.date')[0].addEventListener('tap', function() {
					var today = new Date();
					var datePicker = new mui.DtPicker({type:"date",beginDate: new Date(today.getFullYear(), today.getMonth()),endDate:new Date()});
					var input_relation_date = $(this).find('input[name="relation_date"]')[0];
						datePicker.show(function(rs) {
							input_relation_date.value = rs.text;
							datePicker.dispose();
						});
					}, false);
				$ul_content.find('.btnDelete').click(function(){
					var btnArray = ['否','是'];
					mui.confirm('确认删除吗？', '提示', btnArray, function(e) {
						if (e.index == 1) {
							$ul_content.remove();
						}
					});	
					
				});
			}
		}
		
		function NewAddRow($ul,isedit,dictCode,content){
            if(content == null){
                content = {
                    id : '',
                    option_code : '',
                    content : ''
                };
            }
            var vv='--';
            var str_select_name = 'option'+dictCode;
            var str_input_name = 'input'+dictCode;
            var html = '<li><input type="hidden"  name="content_id" value="'+content.id+'" bidtableflag="true">'+
            				'<select class="new_option_select" name="'+str_select_name+'" bidtableflag="true"'+
            				(isedit == true?'':'disabled')+' ></select>'+
            				'<input type="text" style="color:#CCCCCC" name="'+str_input_name+'" class="new_content_input" value="'+content.content+'" bidtableflag="true"'+
            				(isedit == true?'':'disabled')+' >'+
            				(isedit == true?'<img src="../images/minus_16px.png" class="img_minus"/>':'')+
            				'</li>';
		
            $ul.append(html);
            var $select_option = $ul.find('select[name="'+str_select_name+'"]:last'); 
            var $current_li = $ul.find('li:last');
            var first_code = null;
            $(dict_relation_content_option_resource).each(function(j,dict){
                if(dict.serialNumber == dictCode){
                	if(first_code == null){
                		first_code = dict.dictCode;
                	}
                    $select_option.append('<option value="'+dict.dictCode+'">'+dict.dictText+':</option>');
                }
            });
            if(isedit){
                var $img_minus = $current_li.find('.img_minus:last');
                $img_minus.click(function(){
                    $current_li.remove();
                });
            }

            if(content.option_code != ''){
                $select_option.val(content.option_code);
            }
        }
		
		function addNewStoreRelation(relation) {
			var isedit = false;
			if(typeof(relation) == 'undefined') {
				isedit = true;
				 relation = {
	                id:'',
	                employee_no:employee.employeeId,
	                employee_name:employee.name,
                 	relation_type:'',
	                relation_date:new Date().Format('YYYY-MM-dd'),
					childs:[]
	            }
			}else{
				relation.relation_date = new Date(relation.relation_date).Format('YYYY-MM-dd');
			}
			var $div_parent = $('#item4');
//			var $div_btn = $div_parent.find('.add_btn');
			var html = '<ul class="mui-table-view mui-table-view-chevron ul_interval">'+
					   '<li class="mui-table-view-cell select_li emp">'+
					   '<a>'+
					   '<label>拜访国安侠</label>'+
					   '<input type="hidden" name="relation_id" value="'+relation.id+'" bidtableflag="true">'+
					   '<input type="hidden" name="employee_no" value="'+relation.employee_no+'" bidtableflag="true">'+
					   '<input type="text" name="employee_name" placeholder="请选择" value="'+relation.employee_name+'" bidtableflag="true" readonly style="color:#CCCCCC">'+
					   '</a>'+
					   '</li>'+
					   
   					   '<li class="mui-table-view-cell select_li type">'+
					   '<a>'+
					   '<label>拜访方式<font style="color:red">*</font></label>'+
					   '<input type="text" name="relation_type" placeholder="请选择" value="'+(relation.relation_type == null?'':relation.relation_type)+'" bidtableflag="true" readonly style="color:#CCCCCC">'+
					   '</a>'+
					   '</li>'+
					   
				   	   '<li class="mui-table-view-cell select_li date">'+
					   '<a>'+
					   '<label>拜访时间</label>'+
					   '<input type="text" name="relation_date" placeholder="请选择" value="'+relation.relation_date+'" bidtableflag="true" readonly style="color:#CCCCCC">'+
					   '</a>'+
					   '</li>'+
					   '<li class="mui-table-view-cell input_li reason">'+
					   '<div class="input-row">' +
					   '<label>拜访事由<font style="color:red">*</font></label>'+
					   '<input type="text" style="color:#CCCCCC" id="relation_reason" name="relation_reason" value="'+(relation.relation_reason == null?'':relation.relation_reason)+'" bidtableflag="true"'+
            				(isedit == true?'':'disabled')+' >'+
					   '<input type="hidden" id="customer_type" value="1"/>'+
						'</div>'+
					   '</li>' + 
					    
					   '<li class="mui-table-view-cell input_li feedback_">'+
					   '<div class="input-row">' +
					   '<label>反馈<font style="color:red">*</font></label>'+
					   '<input type="text" style="color:#CCCCCC" id="relation_rcv" name="relation_rcv" value="'+(relation.relation_rcv == null?'':relation.relation_rcv)+'" bidtableflag="true"'+
            				(isedit == true?'':'disabled')+'  >'+
						'</div>'+
					   '</li>';
					   html+= (isedit == true?'<li class="mui-table-view-cell input_li" style="text-align: right;"><button class="btnDelete">删除</button></li>':'')+
					   '</ul>';
					   
//			$div_btn.before(html);
			$div_parent.append(html);
			var $ul = $div_parent.find('ul:last');
			var $li_date = $ul.find('.date');
			var $ul_content = $div_parent.find('ul:last');
	        
	        
	        if(isedit){
				$ul_content.find('.emp')[0].addEventListener('tap',function(event){
					var $input_name = $(this).find('input[name="employee_name"]');
					var $input_no = $(this).find('input[name="employee_no"]');
					employeePicker.show(function(items) {
						$input_name.val(items[0].text);
						$input_no.val(items[0].value);
					});
				});
				
				$ul_content.find('.type')[0].addEventListener('tap',function(event){
					var $input_type = $(this).find('input[name="relation_type"]');
					typePicker.show(function(items) {
						$input_type.val(items[0].text);
					});
				});
	
				$ul_content.find('.date')[0].addEventListener('tap', function() {
					var today = new Date();
					var datePicker = new mui.DtPicker({type:"date",beginDate: new Date(today.getFullYear(), today.getMonth()),endDate:new Date()});
					var input_relation_date = $(this).find('input[name="relation_date"]')[0];
						datePicker.show(function(rs) {
							input_relation_date.value = rs.text;
							datePicker.dispose();
						});
					}, false);
				$ul_content.find('.btnDelete').click(function(){
					var btnArray = ['否','是'];
					mui.confirm('确认删除吗？', '提示', btnArray, function(e) {
						if (e.index == 1) {
							$ul_content.remove();
						}
					});	
					
				});
			}
		}
		function findCustomer() {
			var customer_parameter = {
				name: $('#name').val(),
				mobilephone: $('#mobilephone').val()
			}
			if(customer_parameter.name != null && customer_parameter.name != '' &&
				customer_parameter.mobilephone != null && customer_parameter.mobilephone != '') {
				doManager('CustomerManager', 'findCustomerInfo', customer_parameter, function(data) {
					if(data.result) {
						var customer = JSON.parse(data.data);
						if(customer != null) {
							isOnclick=false;
							$('#item4').children().empty();
							setCustomer(customer);
						}else{
							$("#id").val("");
							$("#create_user_id").val(employee.id);
							$("#create_user").val(employee.name);
							document.getElementById("name").style.color="#000";
			                document.getElementById("mobilephone").style.color="#000";
			                document.getElementById("address").style.color="#000";

						}
					}
				});
			}

		}
		
		function toSelectHose() {
			isOnclick = true;
					var sh_webview = plus.webview.getWebviewById('select_house');
					if(sh_webview != null){
						sh_webview.close();
					}
					mui.openWindow({
						url:'new_select_house.html',
						id:"new_select_house",
						createNew:true,
						show: {
						aniShow: 'slide-in-right'
					},
					waiting: {
						autoShow: false
					},
						extras:{
							address_customer:obj_addressCustomer
						}
					});
				
		}
		
	</script>

</html>